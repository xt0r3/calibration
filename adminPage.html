<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Event Bets Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1020;--card:#11162a;--muted:#7781a9;--text:#e7ebff;--accent:#7c9cff;--line:#1c2340;--danger:#ff6b6b;--ok:#00d07e}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#081024,#0b1020); color:var(--text)}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:22px;margin:0;font-weight:700;letter-spacing:.2px}
    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{border:1px solid var(--line); background:rgba(255,255,255,.02); color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:14px}
    .tab.active{background:var(--accent); color:#0a0f25; border-color:transparent}
    .grid{display:grid; gap:14px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-2{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01)); border:1px solid var(--line); border-radius:14px; padding:16px}
    .card h2{margin:0 0 10px; font-size:16px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%; background:#0f1530; border:1px solid var(--line); color:var(--text); border-radius:10px; padding:10px 12px; outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent)}
    .row{display:flex; gap:10px; align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#0f1530;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--accent);color:#0a0f25;border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.danger{background:#2a1216;border-color:#47171c;color:#ffb3b3}
    .table{width:100%; border-collapse:collapse; font-size:14px}
    .table th,.table td{border-bottom:1px solid var(--line); padding:10px 8px; text-align:left}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#0f1530}
    .pill.ok{border-color:#0a3; background:#0e2e24}
    .pill.bad{border-color:#522; background:#2a1616}
    .hint{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .spacer{height:8px}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Event Bets Admin</h1>
      <div class="row">
        <input id="apiUrl" placeholder="Apps Script Web App URL" style="min-width:340px"/>
        <input id="apiKey" placeholder="API Key (if enabled)"/>
        <button class="btn" onclick="saveConfig()">Save</button>
      </div>
    </header>

    <nav class="tabs" role="tablist">
      <button class="tab active" data-tab="add" onclick="switchTab('add')">Add Event</button>
      <button class="tab" data-tab="resolve" onclick="switchTab('resolve')">Resolve Pending</button>
      <button class="tab" data-tab="resolved" onclick="switchTab('resolved')">Resolved Events</button>
      <button class="tab" data-tab="manage" onclick="switchTab('manage')">Manage Bets</button>
    </nav>

    <!-- ADD EVENT -->
    <section id="tab-add" class="tabpane">
      <div class="grid cols-2">
        <div class="card">
          <h2>1) Define Event</h2>
          <div class="grid">
            <div>
              <label>Event Description</label>
              <input id="newEventDesc" placeholder="e.g., US inflation (Dec)" />
            </div>
            <div>
              <label>Date</label>
              <input id="newEventDate" type="date" />
            </div>
            <div>
              <label>Type of Outcome</label>
              <select id="newEventType" onchange="onNewTypeChange()">
                <option value="Binary">Binary</option>
                <option value="Multiple choice">Multiple choice</option>
                <option value="Continuous">Continuous</option>
              </select>
            </div>
          </div>
          <div class="spacer"></div>
          <div id="outcomesBox">
            <h3 class="hint">Possible outcomes</h3>
            <div id="outcomesList"></div>
            <div class="spacer"></div>
            <button class="btn" onclick="addOutcomeField()">+ Add outcome</button>
          </div>
          <div id="continuousBox" style="display:none">
            <h3 class="hint">Continuous: no predefined list (participants enter a number)</h3>
          </div>
        </div>

        <div class="card">
          <h2>2) Participants</h2>
          <div id="participants"></div>
          <div class="spacer"></div>
          <div class="row">
            <button class="btn" onclick="addParticipantRow()">+ Add participant</button>
            <span class="hint">Probability scale uses 0–1 (e.g., 0.7). You can change on backend to percent if you prefer.</span>
          </div>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="row">
        <button class="btn primary" onclick="submitNewEvent()">Create Event & Bets</button>
        <div id="addStatus" class="hint"></div>
      </div>
    </section>

    <!-- RESOLVE PENDING -->
    <section id="tab-resolve" class="tabpane" style="display:none">
      <div class="card">
        <h2>Resolve Pending Event</h2>
        <div class="grid cols-2">
          <div>
            <label>Event</label>
            <select id="resolveEvent" onchange="onResolveEventChange()"></select>
          </div>
          <div>
            <label>Type</label>
            <input id="resolveType" disabled />
          </div>
        </div>
        <div class="spacer"></div>
        <div id="resolveBinaryBox" class="row" style="display:none">
          <label>Outcome</label>
          <select id="resolveBinary">
            <option>True</option>
            <option>False</option>
          </select>
        </div>
        <div id="resolveMCBox" style="display:none">
          <label>Outcome</label>
          <select id="resolveMC"></select>
        </div>
        <div id="resolveContBox" style="display:none">
          <label>Outcome (number)</label>
          <input id="resolveCont" type="number" step="any" />
        </div>
        <div class="spacer"></div>
        <button class="btn primary" onclick="resolveSelectedEvent()">Resolve</button>
        <span id="resolveStatus" class="hint"></span>
      </div>
    </section>

    <!-- RESOLVED LIST -->
    <section id="tab-resolved" class="tabpane" style="display:none">
      <div class="card">
        <h2>Resolved Events</h2>
        <table class="table" id="resolvedTable">
          <thead>
            <tr>
              <th>Event</th>
              <th>Date</th>
              <th>Type</th>
              <th>Actual Outcome</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- MANAGE BETS -->
    <section id="tab-manage" class="tabpane" style="display:none">
      <div class="card">
        <h2>Manage Bets (Remove)</h2>
        <div class="grid cols-2">
          <div>
            <label>Select Event</label>
            <select id="manageEvent" onchange="loadBetsForManage()"></select>
          </div>
          <div class="row" style="align-items:flex-end">
            <button class="btn" onclick="loadBetsForManage()">Refresh</button>
          </div>
        </div>
        <div class="spacer"></div>
        <table class="table" id="betsTable">
          <thead>
            <tr>
              <th>Counterparty</th>
              <th>Probability</th>
              <th>Outcome</th>
              <th>Date</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ——— Config persistence ———
    function saveConfig(){
      localStorage.setItem('apiUrl', document.getElementById('apiUrl').value.trim());
      localStorage.setItem('apiKey', document.getElementById('apiKey').value.trim());
      toast('Saved settings');
      boot();
    }
    function loadConfig(){
      const u = localStorage.getItem('apiUrl')||'';
      const k = localStorage.getItem('apiKey')||'';
      document.getElementById('apiUrl').value = u;
      document.getElementById('apiKey').value = k;
      return {url:u,key:k};
    }

    // ——— Minimal toast ———
    function toast(msg){
      const d=document.createElement('div');
      d.textContent=msg; d.style.position='fixed'; d.style.bottom='16px'; d.style.right='16px'; d.style.background='var(--card)'; d.style.border='1px solid var(--line)'; d.style.padding='10px 12px'; d.style.borderRadius='10px'; d.style.boxShadow='0 6px 24px rgba(0,0,0,.3)';
      document.body.appendChild(d); setTimeout(()=>d.remove(),1800);
    }

    // ——— Tabs ———
    function switchTab(name){
      document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
      document.querySelectorAll('.tabpane').forEach(p=>p.style.display='none');
      document.getElementById(`tab-${name}`).style.display='block';
      if(name==='resolve'){ loadPendingForResolve(); }
      if(name==='resolved'){ loadResolved(); }
      if(name==='manage'){ loadManageEventsList(); }
    }

    // ——— Dynamic outcomes UI for Add Event ———
    function onNewTypeChange(){
      const t = document.getElementById('newEventType').value;
      document.getElementById('outcomesBox').style.display = (t==='Multiple choice')?'block':(t==='Binary'?'block':'none');
      document.getElementById('continuousBox').style.display = (t==='Continuous')?'block':'none';
      const list = document.getElementById('outcomesList');
      list.innerHTML='';
      if(t==='Binary'){
        list.appendChild(outcomeField('True'));
        list.appendChild(outcomeField('False'));
      } else if(t==='Multiple choice'){
        addOutcomeField();
      }
      // update participant rows outcome inputs
      rebuildParticipantOutcomeInputs();
    }
    function outcomeField(value=''){
      const wrap=document.createElement('div'); wrap.className='row';
      const inp=document.createElement('input'); inp.placeholder='Outcome'; inp.value=value; inp.oninput=rebuildParticipantOutcomeInputs;
      const del=document.createElement('button'); del.className='btn danger'; del.textContent='Remove'; del.onclick=()=>{wrap.remove(); rebuildParticipantOutcomeInputs();};
      wrap.appendChild(inp); wrap.appendChild(del); return wrap;
    }
    function addOutcomeField(){ document.getElementById('outcomesList').appendChild(outcomeField('')); }
    function getDefinedOutcomes(){
      const t = document.getElementById('newEventType').value;
      if(t==='Continuous') return [];
      const vals=[...document.querySelectorAll('#outcomesList input')].map(i=>i.value.trim()).filter(Boolean);
      // For Binary ensure True/False unique
      return [...new Set(vals)];
    }

    // ——— Participants UI ———
    function addParticipantRow(){
      const row=document.createElement('div'); row.className='row'; row.style.gap='8px'; row.style.marginBottom='8px';
      const name=document.createElement('input'); name.placeholder='Counterparty'; name.style.minWidth='160px';
      const prob=document.createElement('input'); prob.placeholder='Probability (0–1)'; prob.type='number'; prob.step='any'; prob.min='0'; prob.max='1'; prob.style.width='160px';
      const outcomeWrap=document.createElement('div'); outcomeWrap.style.flex='1';
      row.appendChild(name); row.appendChild(prob); row.appendChild(outcomeWrap);
      const del=document.createElement('button'); del.className='btn danger'; del.textContent='Remove'; del.onclick=()=>row.remove(); row.appendChild(del);
      document.getElementById('participants').appendChild(row);
      buildOutcomeInputForRow(row);
    }
    function rebuildParticipantOutcomeInputs(){
      document.querySelectorAll('#participants > .row').forEach(buildOutcomeInputForRow);
    }
    function buildOutcomeInputForRow(row){
      const t = document.getElementById('newEventType').value;
      const wrap=row.children[2]; // outcomeWrap
      wrap.innerHTML='';
      const label=document.createElement('label'); label.textContent='Outcome'; wrap.appendChild(label);
      if(t==='Continuous'){
        const inp=document.createElement('input'); inp.type='number'; inp.step='any'; inp.placeholder='Outcome (number)'; wrap.appendChild(inp);
      }else{
        const opts=getDefinedOutcomes();
        const sel=document.createElement('select');
        opts.forEach(o=>{ const op=document.createElement('option'); op.textContent=o; sel.appendChild(op);});
        wrap.appendChild(sel);
      }
    }

    // ——— API Helper ———
    async function api(path, method='GET', body){
      const {url,key}=loadConfig();
      if(!url){ throw new Error('Missing Apps Script Web App URL'); }
      const headers={'Content-Type':'application/json'}; if(key) headers['X-API-KEY']=key;
      const res = await fetch(url + path, { method, headers, body: body?JSON.stringify(body):undefined });
      if(!res.ok){ const txt=await res.text(); throw new Error(txt||('HTTP '+res.status)); }
      return res.json();
    }

    // ——— Submit new event ———
    async function submitNewEvent(){
      const status = document.getElementById('addStatus'); status.textContent='';
      try{
        const desc=document.getElementById('newEventDesc').value.trim();
        const date=document.getElementById('newEventDate').value;
        const type=document.getElementById('newEventType').value;
        if(!desc) throw new Error('Event Description is required');
        if(!date) throw new Error('Date is required');

        const outcomes = type==='Continuous' ? [] : getDefinedOutcomes();
        if((type==='Binary'||type==='Multiple choice') && outcomes.length===0){ throw new Error('Please add at least one outcome'); }

        const participants=[...document.querySelectorAll('#participants > .row')].map(r=>{
          const name=r.children[0].value.trim();
          const prob=parseFloat(r.children[1].value);
          const outcomeWrap=r.children[2];
          const outcomeInput= outcomeWrap.querySelector('select, input');
          const outcome = outcomeInput ? outcomeInput.value : '';
          return { name, probability:prob, outcome };
        }).filter(p=>p.name);
        if(participants.length===0) throw new Error('Add at least one participant');
        if(participants.some(p=>isNaN(p.probability))) throw new Error('All probabilities must be numbers');

        // Validate participant outcomes against defined outcomes for discrete types
        if(type!=='Continuous'){
          const allowed=new Set(outcomes);
          for(const p of participants){ if(!allowed.has(p.outcome)) throw new Error(`Participant "${p.name}" has invalid outcome: ${p.outcome}`); }
        }

        // Create event + options + bets in one call
        await api('/events', 'POST', { description:desc, date, type, outcomes, participants });
        status.textContent='✅ Saved'; toast('Event & bets created');
        // reset
        document.getElementById('newEventDesc').value='';
        document.getElementById('newEventDate').value='';
        document.getElementById('participants').innerHTML='';
        onNewTypeChange(); addParticipantRow();
      }catch(err){ status.textContent='⚠️ '+err.message; }
    }

    // ——— Resolve pending ———
    async function loadPendingForResolve(){
      const sel=document.getElementById('resolveEvent'); sel.innerHTML='';
      const data = await api('/events?status=pending');
      data.events.forEach(ev=>{ const o=document.createElement('option'); o.value=ev.description; o.textContent=ev.description; o.dataset.type=ev.type; sel.appendChild(o);});
      if(data.events.length){ onResolveEventChange(); }
    }
    async function onResolveEventChange(){
      const sel=document.getElementById('resolveEvent'); const desc=sel.value; if(!desc) return;
      const info = await api('/event?description='+encodeURIComponent(desc));
      document.getElementById('resolveType').value = info.type || '';
      document.getElementById('resolveBinaryBox').style.display='none';
      document.getElementById('resolveMCBox').style.display='none';
      document.getElementById('resolveContBox').style.display='none';
      if(info.type==='Binary'){
        document.getElementById('resolveBinaryBox').style.display='flex';
      } else if(info.type==='Multiple choice'){
        const selMC=document.getElementById('resolveMC'); selMC.innerHTML='';
        info.options.forEach(o=>{ const op=document.createElement('option'); op.textContent=o; selMC.appendChild(op); });
        document.getElementById('resolveMCBox').style.display='block';
      } else if(info.type==='Continuous'){
        document.getElementById('resolveContBox').style.display='block';
      }
    }
    async function resolveSelectedEvent(){
      const desc=document.getElementById('resolveEvent').value; if(!desc) return;
      const type=document.getElementById('resolveType').value;
      let actual=null;
      if(type==='Binary'){ actual=document.getElementById('resolveBinary').value; }
      if(type==='Multiple choice'){ actual=document.getElementById('resolveMC').value; }
      if(type==='Continuous'){ actual=parseFloat(document.getElementById('resolveCont').value); if(isNaN(actual)) return toast('Enter a number'); }
      await api('/resolve', 'POST', { description:desc, actual });
      document.getElementById('resolveStatus').textContent='✅ Resolved';
      toast('Event resolved');
      loadPendingForResolve();
      loadResolved();
    }

    // ——— Resolved list ———
    async function loadResolved(){
      const data = await api('/events?status=resolved');
      const tb = document.querySelector('#resolvedTable tbody'); tb.innerHTML='';
      data.events.forEach(ev=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${escapeHtml(ev.description)}</td><td>${ev.date||''}</td><td>${ev.type||''}</td><td>${ev.actual ?? ''}</td>`;
        tb.appendChild(tr);
      });
    }

    // ——— Manage bets ———
    async function loadManageEventsList(){
      const sel=document.getElementById('manageEvent'); sel.innerHTML='';
      const data = await api('/events?status=all');
      data.events.forEach(ev=>{ const o=document.createElement('option'); o.value=ev.description; o.textContent=ev.description; sel.appendChild(o);});
      if(data.events.length){ loadBetsForManage(); }
    }
    async function loadBetsForManage(){
      const desc=document.getElementById('manageEvent').value; if(!desc) return;
      const list = await api('/results?description='+encodeURIComponent(desc));
      const tb=document.querySelector('#betsTable tbody'); tb.innerHTML='';
      list.rows.forEach(row=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(row.counterparty||'')}</td>
                        <td>${row.probability}</td>
                        <td>${escapeHtml(String(row.outcome))}</td>
                        <td>${row.date||''}</td>
                        <td><button class="btn danger" onclick="deleteBet(${row.id})">Delete</button></td>`;
        tb.appendChild(tr);
      });
    }
    async function deleteBet(id){
      if(!confirm('Remove this bet?')) return;
      await api('/bet', 'DELETE', { id });
      toast('Bet removed');
      loadBetsForManage();
    }

    // ——— Utils ———
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // ——— Boot ———
    function boot(){ onNewTypeChange(); if(!document.querySelector('#participants > .row')) addParticipantRow(); }
    window.addEventListener('load', ()=>{ loadConfig(); boot(); });
  </script>
</body>
</html>